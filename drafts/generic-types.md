# Calcit å±€éƒ¨å˜é‡ç±»å‹æ ‡è®°æ–¹æ¡ˆè¯„ä¼°

æœ¬æ–‡æ¡£è¯„ä¼°åœ¨ Calcit ä¸­ä¸º `Local` å˜é‡è¡¥å……ç±»å‹ä¿¡æ¯çš„æŠ€æœ¯æ–¹æ¡ˆåŠå·¥ä½œé‡ã€‚

## 1. æ ¸å¿ƒç›®æ ‡

- åœ¨å®å±•å¼€åçš„ IR (Intermediate Representation) ä¸­ï¼Œä¸º `Local` å˜é‡å…³è”ç±»å‹ä¿¡æ¯ã€‚
- æ”¯æŒ `assert-type` å’Œ `hint-fn` è¯­æ³•è¿›è¡Œå‡½æ•°å‚æ•°ã€è¿”å›å€¼ç±»å‹æ ‡è®°ã€‚
- è‡ªåŠ¨åˆ©ç”¨ `Record` ä¿¡æ¯è¿›è¡Œæ–¹æ³•è°ƒç”¨ï¼ˆMethod Callï¼‰çš„é™æ€éªŒè¯ã€‚
- å…è®¸ `unknown` ç±»å‹ï¼Œå¹¶æä¾›è¿è¡Œæ—¶æŸ¥çœ‹æ‰‹æ®µã€‚
- ä¸ºå†…ç½®å‡½æ•°è¡¥å……ç±»å‹æç¤ºï¼Œä¿æŒå‘åå…¼å®¹ã€‚

## 2. æŠ€æœ¯æ–¹æ¡ˆå»ºè®®

### 2.0 ç±»å‹å£°æ˜è¯­æ³•è®¾è®¡

Calcit ä»¥å‰æ²¡æœ‰é¢„ç½®å‡½æ•°ç±»å‹å†™æ³•ï¼Œç°é€šè¿‡ `assert-type` å’Œ `hint-fn` æ¥å£°æ˜ç±»å‹ä¿¡æ¯ï¼š

#### 2.0.1 åŸºæœ¬ç±»å‹å£°æ˜

```cirru
defn f1 (x y)
  assert-type x :number                    ; å£°æ˜å‚æ•° x ä¸º number ç±»å‹
  assert-type y $ :fn (:number) :number    ; å£°æ˜å‚æ•° y ä¸ºå‡½æ•°ç±»å‹
  hint-fn $ return-type :number             ; å£°æ˜è¿”å›å€¼ç±»å‹
  &+ x (y 10)
```

#### 2.0.2 ç±»å‹è¡¨ç¤ºæ–¹å¼

- **å†…ç½®ç±»å‹**ï¼šä½¿ç”¨ Tag ç›´æ¥è¡¨ç¤º

  - `:number` - æ•°å­—ç±»å‹
  - `:string` - å­—ç¬¦ä¸²ç±»å‹
  - `:bool` - å¸ƒå°”ç±»å‹
  - `:nil` - nil ç±»å‹
  - `:keyword` - å…³é”®å­—ç±»å‹
  - `:fn` - å‡½æ•°ç±»å‹ï¼ˆåŸºç¡€å½¢å¼ï¼‰
  - `:fn (arg-types...) return-type` - å‡½æ•°ç±»å‹ï¼ˆå¸¦ç­¾åï¼‰

- **è‡ªå®šä¹‰ç±»å‹**ï¼šä½¿ç”¨ Record å®šä¹‰æ¥è¡¨ç¤º

  - `:User` - å½“å‰ namespace ä¸­å®šä¹‰çš„ Record
  - ç±»å‹ä¿¡æ¯é€šè¿‡ `defrecord` å…³è”çš„å…ƒæ•°æ®è·å–

- **å¤åˆç±»å‹**ï¼š
  - `:list :number` - å…ƒç´ ä¸º number çš„ list
  - `:map :keyword :string` - key ä¸º keywordï¼Œvalue ä¸º string çš„ map

#### 2.0.3 `assert-type` è¯­æ³•

`assert-type` ç”¨äºåœ¨å‡½æ•°ä½“å†…å£°æ˜å˜é‡ç±»å‹ï¼š

```cirru
assert-type <variable> <type-expr>
```

- `<variable>`ï¼šè¦æ ‡æ³¨ç±»å‹çš„å˜é‡åï¼ˆSymbolï¼‰
- `<type-expr>`ï¼šç±»å‹è¡¨è¾¾å¼ï¼Œå¯ä»¥æ˜¯ Tag æˆ–åµŒå¥—çš„åˆ—è¡¨ç»“æ„

ç¤ºä¾‹ï¼š

```cirru
defn process-user (user)
  assert-type user :User       ; user æ˜¯ User Record ç±»å‹
  get user :name               ; å¯ä»¥é™æ€æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨

defn map-numbers (f xs)
  assert-type f $ :fn (:number) :number    ; f æ˜¯å‡½æ•°ç±»å‹
  assert-type xs $ :list :number            ; xs æ˜¯ number åˆ—è¡¨
  map f xs
```

#### 2.0.4 `hint-fn` è¯­æ³•

`hint-fn` ç”¨äºåœ¨å‡½æ•°ä½“å†…å£°æ˜å‡½æ•°çº§åˆ«çš„å…ƒä¿¡æ¯ï¼ˆå¦‚è¿”å›å€¼ç±»å‹ï¼‰ï¼š

```cirru
hint-fn $ return-type <type-expr>
```

ç¤ºä¾‹ï¼š

```cirru
defn add-numbers (a b)
  assert-type a :number
  assert-type b :number
  hint-fn $ return-type :number
  &+ a b
```

#### 2.0.5 ç±»å‹ä¼ æ’­æœºåˆ¶

1. `assert-type` å°†ç±»å‹ä¿¡æ¯æ³¨å…¥åˆ° `ScopeTypes` æ˜ å°„ä¸­
2. é¢„å¤„ç†å™¨åœ¨è½¬æ¢ `Symbol` â†’ `Local` æ—¶æŸ¥è¯¢å¹¶å¡«å…… `type_info` å­—æ®µ
3. ç±»å‹ä¿¡æ¯åœ¨ä½œç”¨åŸŸå†…ä¼ æ’­ï¼Œåç»­å¯¹åŒä¸€å˜é‡çš„å¼•ç”¨ä¿ç•™ç±»å‹æ ‡æ³¨
4. `hint-fn` çš„è¿”å›å€¼ç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨å‡½æ•°å®šä¹‰çš„å…ƒæ•°æ®ä¸­

#### 2.0.6 æœªæ ‡æ³¨ç±»å‹çš„å¤„ç†

- é»˜è®¤æ‰€æœ‰æœªæ ‡æ³¨çš„å˜é‡ `type_info` ä¸º `None`ï¼Œå¯¹åº” `unknown` ç±»å‹
- `unknown` ç±»å‹ä¸è§¦å‘é™æ€ç±»å‹æ£€æŸ¥
- ä¿æŒå‘åå…¼å®¹ï¼šè€ä»£ç æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ

### 2.1 æ•°æ®ç»“æ„è°ƒæ•´

#### 2.1.1 `CalcitLocal` æ‰©å±•

åœ¨ `src/calcit/local.rs` ä¸­ä¿®æ”¹ `CalcitLocal` ç»“æ„ä½“ï¼š

```rust
pub struct CalcitLocal {
  pub idx: u16,
  pub sym: Arc<str>,
  pub info: Arc<CalcitSymbolInfo>,
  pub location: Option<Arc<Vec<u16>>>,
  // æ–°å¢ï¼šç±»å‹ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯ Tag, Record æˆ–å…¶å®ƒ Calcit å€¼
  pub type_info: Option<Arc<Calcit>>,
}
```

#### 2.1.2 å‡½æ•°å®šä¹‰å…ƒæ•°æ®æ‰©å±•

ä¸ºæ”¯æŒ `hint-fn` å£°æ˜çš„è¿”å›å€¼ç±»å‹ï¼Œéœ€è¦åœ¨å‡½æ•°ç›¸å…³ç»“æ„ä¸­æ·»åŠ ç±»å‹å…ƒæ•°æ®å­—æ®µï¼š

```rust
// åœ¨å‡½æ•°å®šä¹‰ç›¸å…³ç»“æ„ä¸­æ·»åŠ ï¼ˆå…·ä½“ä½ç½®å–å†³äºå®ç°ï¼‰
pub struct FnInfo {
  // ... ç°æœ‰å­—æ®µ
  pub return_type: Option<Arc<Calcit>>,  // è¿”å›å€¼ç±»å‹
  pub arg_types: Vec<Option<Arc<Calcit>>>, // å‚æ•°ç±»å‹åˆ—è¡¨
}
```

- `return_type`: é€šè¿‡ `hint-fn $ return-type :type` å£°æ˜
- `arg_types`: é€šè¿‡ `assert-type arg :type` åœ¨å‡½æ•°ä½“å†…æ”¶é›†
- é»˜è®¤å€¼ä¸º `None`ï¼Œè¡¨ç¤º `unknown` ç±»å‹

### 2.2 é¢„å¤„ç†å™¨å¢å¼º (`preprocess.rs`)

é¢„å¤„ç†å™¨æ˜¯ç±»å‹ä¿¡æ¯æ³¨å…¥çš„å…³é”®ä½ç½®ï¼š

1. **ä½œç”¨åŸŸè·Ÿè¸ª**ï¼š`preprocess_expr` éœ€è¦ä¼ é€’ä¸€ä¸ªç±»å‹æ˜ å°„è¡¨ `ScopeTypes = HashMap<Arc<str>, Arc<Calcit>>`ã€‚

2. **`assert-type` å¤„ç†**ï¼š

   - è¯†åˆ« `assert-type var type` è¯­æ³•èŠ‚ç‚¹
   - è§£æ `var` å¯¹åº”çš„å˜é‡åï¼Œå°† `type` è¡¨è¾¾å¼æ±‚å€¼å¹¶è®°å½•åˆ° `ScopeTypes` æ˜ å°„ä¸­
   - `assert-type` åœ¨é¢„å¤„ç†åå¯ä»¥ä½œä¸º No-op æˆ–ä¿ç•™ä½œä¸ºè¿è¡Œæ—¶æ–­è¨€

3. **`hint-fn` å¤„ç†**ï¼š

   - è¯†åˆ« `hint-fn $ return-type type` è¯­æ³•
   - å°†è¿”å›å€¼ç±»å‹ä¿¡æ¯å…³è”åˆ°å½“å‰å‡½æ•°å®šä¹‰çš„å…ƒæ•°æ®ä¸­
   - å¯æ‰©å±•æ”¯æŒå…¶ä»–å‡½æ•°çº§åˆ«çš„æç¤ºï¼ˆå¦‚ `hint-fn $ pure true`ï¼‰

4. **Local ç”Ÿæˆ**ï¼š

   - å½“é¢„å¤„ç†å™¨å°† `Symbol` è½¬æ¢ä¸º `Local` æ—¶ï¼Œä» `ScopeTypes` ä¸­æŸ¥è¯¢å¹¶å¡«å…… `type_info`
   - ç¡®ä¿ç±»å‹ä¿¡æ¯åœ¨ä½œç”¨åŸŸå†…æ­£ç¡®ä¼ æ’­

5. **æ–¹æ³•æ ¡éªŒ**ï¼š
   - åœ¨ `preprocess_list_call` ä¸­ï¼Œè¯†åˆ« `get`/`.-field` ç­‰æ–¹æ³•è°ƒç”¨
   - å¦‚æœå‚æ•°æ˜¯å¸¦æœ‰ `Record` ç±»å‹çš„ `Local`ï¼Œæ ¹æ® Record å®šä¹‰æ ¡éªŒå­—æ®µåˆæ³•æ€§
   - ä¸åŒ¹é…æ—¶ç”Ÿæˆ `LocatedWarning`

### 2.3 å†…ç½®å‡½æ•°ä¸ç±»å‹æç¤º

- **Procs æ³¨å†Œ**ï¼šåœ¨ `src/builtins.rs` ä¸­ï¼Œéœ€è¦ä¸€ç§æ–¹å¼ä¸º `CalcitProc` å…³è”ç­¾åä¿¡æ¯ã€‚
- **å…¼å®¹æ€§**ï¼šè€ä»£ç ä¿æŒ `type_info` ä¸º `None` (å³ `unknown`)ï¼Œä¸è¿›è¡Œå¼ºæ ¡éªŒã€‚

### 2.4 è¿è¡Œæ—¶æ”¯æŒ

- å¢åŠ  `&inspect-type` åŸè¯­ï¼Œå…è®¸åœ¨è¿è¡Œæ—¶é€šè¿‡ `CalcitLocal` è·å–å…¶æ ‡è®°çš„ç±»å‹åã€‚

## 3. å·¥ä½œé‡è¯„ä¼°

| æ¨¡å—                | ä»»åŠ¡æè¿°                                                         | é¢„è®¡å·¥æ—¶ (å¤©) |
| :------------------ | :--------------------------------------------------------------- | :------------ |
| **åŸºç¡€æ¶æ„**        | ä¿®æ”¹ `CalcitLocal` ç»“æ„åŠç›¸å…³çš„ `Hash`/`Ord`/`Eq` å®ç°           | 1             |
| **æ ¸å¿ƒè¯­æ³•**        | æ·»åŠ  `assert-type` å’Œ `hint-fn` åˆ° `CalcitSyntax` å¹¶æ›´æ–°è§£æé€»è¾‘ | 1.5           |
| **é¢„å¤„ç†å™¨ (æ ¸å¿ƒ)** | å®ç°åŸºäºä½œç”¨åŸŸçš„ç±»å‹è·Ÿè¸ªï¼Œå¤„ç†ç±»å‹æ ‡è®°æ³¨å…¥                       | 5             |
| **Record åˆ†æ**     | å®ç°æ–¹æ³•è°ƒç”¨ä¸ Record å­—æ®µçš„é™æ€åŒ¹é…æ ¡éªŒ                         | 2             |
| **å†…ç½®å‡½æ•°é€‚é…**    | å»ºç«‹å†…ç½®å‡½æ•°ç±»å‹æè¿°ä½“ç³»ï¼Œé€‚é…å¸¸ç”¨æ ¸å¿ƒå‡½æ•°                       | 3             |
| **è°ƒè¯•å·¥å…·**        | å®ç° `inspect-type` åŠç›¸å…³çš„é”™è¯¯ä¿¡æ¯å¢å¼º                         | 1             |
| **æµ‹è¯•ä¸æ–‡æ¡£**      | ç¼–å†™æµ‹è¯•ç”¨ä¾‹éªŒè¯ç±»å‹ä¼ æ’­åŠè¾¹ç•Œæƒ…å†µ                               | 2             |
| **æ€»è®¡**            |                                                                  | **çº¦ 15 å¤©**  |

## 4. é£é™©ä¸è€ƒé‡

- **å®å±•å¼€é¡ºåº**ï¼šç”±äºç±»å‹æ ‡è®°å¯èƒ½å‡ºç°åœ¨å®å±•å¼€ä¹‹åï¼Œé¢„å¤„ç†å™¨å¿…é¡»ç¡®ä¿åœ¨æ‰€æœ‰å®å®Œå…¨å±•å¼€åä»èƒ½æ­£ç¡®å…³è”ç±»å‹ã€‚
- **æ€§èƒ½å¼€é”€**ï¼šåœ¨é¢„å¤„ç†é˜¶æ®µå¢åŠ å“ˆå¸ŒæŸ¥æ‰¾å’Œç±»å‹æ¯”å¯¹ä¼šæœ‰ä¸€å®šçš„ç¼–è¯‘æ€§èƒ½æŸè€—ã€‚
- **å¤æ‚ç±»å‹**ï¼šç›®å‰æ–¹æ¡ˆä¸»è¦é’ˆå¯¹ `Record` å’ŒåŸºç¡€ç±»å‹ï¼Œæš‚ä¸è€ƒè™‘æ³›å‹æˆ–å¤æ‚çš„è”åˆç±»å‹ï¼Œä»¥é™ä½å®ç°éš¾åº¦ã€‚

## 5. é˜¶æ®µæ€§å¼€å‘è®¡åˆ’

| é˜¶æ®µ                         | ç›®æ ‡                                                                                        | äº¤ä»˜ç‰©                                                             |
| :--------------------------- | :------------------------------------------------------------------------------------------ | :----------------------------------------------------------------- |
| **é˜¶æ®µ 1ï¼šæ•°æ®ç»“æ„å‡†å¤‡**     | æ‰©å±• `CalcitLocal` ç»“æ„ä¸æ´¾ç”Ÿå®ç°ï¼Œé¢„ç•™ `type_info` å­—æ®µï¼ŒåŠ å…¥ `assert-type` è¯­æ³•å ä½ã€‚     | å¯ç¼–è¯‘ç‰ˆæœ¬ + åŸºç¡€å•æµ‹è¦†ç›– `CalcitLocal` åºåˆ—åŒ–/æ¯”è¾ƒé€»è¾‘ã€‚          |
| **é˜¶æ®µ 2ï¼šè¯­æ³•è§£æ**         | åœ¨ Cirruâ†’Calcit è½¬æ¢ä»¥åŠé¢„å¤„ç†å™¨ä¸­è¯†åˆ« `assert-type` å’Œ `hint-fn`ï¼Œèƒ½å¤Ÿåœ¨ AST ä¸­ä¿ç•™æ³¨è§£ã€‚  | `cr --check-only` æ ·ä¾‹ï¼Œé€šè¿‡ Cirru ç¤ºä¾‹å±•ç¤º `assert-type` è¡¨è¾¾å¼ã€‚ |
| **é˜¶æ®µ 3ï¼šç±»å‹ä¼ æ’­**         | åœ¨ `preprocess_defn`/`preprocess_core_let` ç­‰å¤„ä¼ é€’ç±»å‹æ˜ å°„ï¼Œ`Local` èŠ‚ç‚¹å¸¦ä¸Š `type_info`ã€‚ | demo å‡½æ•° + `&inspect-type` ä¸´æ—¶ helperï¼Œè¯æ˜ç±»å‹ä¿¡æ¯å¯æŸ¥è¯¢ã€‚      |
| **é˜¶æ®µ 4ï¼šRecord é™æ€æ ¡éªŒ**  | é’ˆå¯¹æ–¹æ³•è°ƒç”¨ä¸ `Record` ç±»å‹åšå­—æ®µæ ¡éªŒï¼Œé”™è¯¯ä¿¡æ¯å¯å®šä½ã€‚                                    | åˆæ³•/éæ³•è°ƒç”¨ç¤ºä¾‹ã€`cr query error` è¾“å‡ºæˆªå›¾ã€‚                     |
| **é˜¶æ®µ 5ï¼šè¿è¡Œæ—¶ä¸å†…ç½®å‡½æ•°** | æä¾› `&inspect-type`ã€è¡¥å……éƒ¨åˆ†å†…ç½®å‡½æ•°ç­¾åï¼Œç¡®ä¿æœªæ ‡æ³¨æ—¶å›é€€ `unknown`ã€‚                    | è¿è¡Œæ—¶ç¤ºä¾‹ + æ–‡æ¡£æ›´æ–° + é¢å¤–æµ‹è¯•ã€‚                                 |

æ¯ä¸ªé˜¶æ®µç»“æŸåéƒ½éœ€æäº¤ä¸€ä»½å¯æ­£å¸¸ç¼–è¯‘çš„ç‰ˆæœ¬ï¼Œå¹¶é™„ä¸Šå¯¹åº” Cirru ç¤ºä¾‹æˆ– Rust æµ‹è¯•è¾“å‡ºï¼Œæ–¹ä¾¿éªŒæ”¶ã€‚

**é˜¶æ®µè¿›å±•ï¼ˆæˆªè‡³ 2026-01-08 æ™šï¼‰**

- âœ… **é˜¶æ®µ 1**ï¼š`CalcitLocal` å’Œ `CalcitFn` ç»“æ„å·²æ‰©å±•ï¼Œæ‰€æœ‰å¿…è¦å­—æ®µæ·»åŠ å®Œæˆï¼›`cargo test` é€šè¿‡ã€‚
- âœ… **é˜¶æ®µ 2**ï¼šè¯­æ³•è§£æå®Œæˆ
  - âœ… `assert-type` è¯­æ³•å·²æ­£ç¡®è¯†åˆ«å’Œè§£æ
  - âœ… `hint-fn` è¯­æ³•å·²è¯†åˆ«ï¼ˆè¿è¡Œæ—¶ä¸º no-opï¼‰
  - âœ… æµ‹è¯•ç”¨ä¾‹å·²æ›´æ–°ï¼š`parses_assert_type_list`ã€`passes_assert_type_through_preprocess`
- âœ… **é˜¶æ®µ 3**ï¼šç±»å‹ä¼ æ’­å®Œæˆ
  - âœ… é¢„å¤„ç†å™¨ç»´æŠ¤å±€éƒ¨ç±»å‹æ˜ å°„ï¼ˆ`ScopeTypes`ï¼‰
  - âœ… `assert-type` åœ¨é¢„å¤„ç†åè¿”å› `Nil`ï¼Œç±»å‹ä¿¡æ¯æ³¨å…¥åˆ° `Local.type_info` å’Œ `ScopeTypes`
  - âœ… ç±»å‹ä¿¡æ¯åœ¨ä½œç”¨åŸŸå†…æ­£ç¡®ä¼ æ’­
  - âœ… æµ‹è¯•éªŒè¯é€šè¿‡ï¼š`propagates_type_info_across_scope`
  - âœ… å®é™… Cirru ä»£ç æµ‹è¯•é€šè¿‡ï¼ˆ`calcit/test-types.cirru`ï¼‰
- ğŸš§ **é˜¶æ®µ 4**ï¼šRecord/Enum é™æ€æ ¡éªŒéƒ¨åˆ†å®Œæˆ
  - âœ… å®ç°äº† `&record:get` å­—æ®µéªŒè¯
  - âœ… å®ç°äº† `.-field` æ–¹æ³•è®¿é—®è¯­æ³•çš„å­—æ®µéªŒè¯
  - âœ… å•å…ƒæµ‹è¯•éªŒè¯é€šè¿‡ï¼š`validates_record_field_access`ã€`warns_on_invalid_record_field`ã€`validates_method_field_access`ã€`warns_on_invalid_method_field_access`
  - âš ï¸ **å½“å‰é™åˆ¶**ï¼šåªæ”¯æŒåŸºäº `ScopeTypes` çš„é™æ€éªŒè¯ï¼Œéœ€è¦åœ¨ä»£ç ä¸­æ˜¾å¼ä½¿ç”¨ `assert-type` æ ‡æ³¨
  - â¸ï¸ å¾…å®Œæˆï¼šåŸºäº Record å­—é¢é‡æ¨æ–­ç±»å‹
  - â¸ï¸ å¾…å®Œæˆï¼šEnum å˜ä½“éªŒè¯

### å½“å‰å®ç°çŠ¶æ€è¯´æ˜ï¼ˆ2026-01-09 æ›´æ–°ï¼‰

**å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½ï¼š**

1. âœ… `CalcitLocal.type_info: Option<Arc<Calcit>>` - å˜é‡ç±»å‹ä¿¡æ¯å­˜å‚¨
2. âœ… `CalcitFn.return_type` å’Œ `CalcitFn.arg_types` - å‡½æ•°ç±»å‹å…ƒæ•°æ®
3. âœ… `assert-type var type` è¯­æ³•å®Œæ•´å®ç°ï¼š
   - Cirru è§£ææ­£ç¡®è¯†åˆ«
   - é¢„å¤„ç†å™¨å°†ç±»å‹æ³¨å…¥ `ScopeTypes` å’Œ `Local.type_info`
   - é¢„å¤„ç†åè¿”å› `Nil`ï¼ˆè¿è¡Œæ—¶æ— å½±å“ï¼‰
4. âœ… `hint-fn $ return-type :type` è¯­æ³•è¯†åˆ«ï¼ˆè¿è¡Œæ—¶ no-opï¼‰
5. âœ… ç±»å‹ä¿¡æ¯åœ¨ä½œç”¨åŸŸå†…ä¼ æ’­ï¼Œåç»­å¼•ç”¨ä¿ç•™ç±»å‹æ ‡æ³¨
6. âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆ11 ä¸ªæµ‹è¯•ï¼‰
7. âœ… å®é™… Cirru ä»£ç å¯ä»¥ä½¿ç”¨ç±»å‹æ ‡æ³¨å¹¶æ­£å¸¸è¿è¡Œ
8. âœ… **Record å­—æ®µéªŒè¯**ï¼š
   - âœ… åœ¨é¢„å¤„ç†é˜¶æ®µæ£€æŸ¥ `&record:get` è°ƒç”¨
   - âœ… åœ¨é¢„å¤„ç†é˜¶æ®µæ£€æŸ¥ `.-field` æ–¹æ³•è®¿é—®è¯­æ³•ï¼ˆå¦‚ `user.-name`ï¼‰
   - âœ… éªŒè¯å­—æ®µåæ˜¯å¦å­˜åœ¨äº Record ç±»å‹å®šä¹‰ä¸­
   - âœ… ç”Ÿæˆç¼–è¯‘æ—¶è­¦å‘Šæç¤ºå­—æ®µé”™è¯¯

**æµ‹è¯•è¦†ç›–ï¼š**
- `calcit/test-types.cirru` - åŒ…å«å¤šç§ç±»å‹æ ‡æ³¨åœºæ™¯çš„å®é™…ä»£ç æµ‹è¯•
- å•å…ƒæµ‹è¯•éªŒè¯ç±»å‹è§£æã€ä¼ æ’­å’Œä½œç”¨åŸŸç®¡ç†
- Record å­—æ®µéªŒè¯å•å…ƒæµ‹è¯•ï¼ˆ4ä¸ªï¼‰ï¼š
  - `validates_record_field_access` - `&record:get` æ­£ç¡®å­—æ®µ
  - `warns_on_invalid_record_field` - `&record:get` é”™è¯¯å­—æ®µ
  - `validates_method_field_access` - `.-field` æ­£ç¡®å­—æ®µ
  - `warns_on_invalid_method_field_access` - `.-field` é”™è¯¯å­—æ®µ

**Record å­—æ®µéªŒè¯ç¤ºä¾‹ï¼š**
```rust
// å•å…ƒæµ‹è¯•ä¸­çš„ç¤ºä¾‹
let test_record = Calcit::Record(CalcitRecord {
  name: EdnTag::from("Person"),
  fields: Arc::new(vec![EdnTag::from("age"), EdnTag::from("name")]),
  values: Arc::new(vec![Calcit::Nil, Calcit::Nil]),
  class: None,
});

// åœ¨ scope_types ä¸­æ³¨å†Œç±»å‹
scope_types.insert(Arc::from("user"), Arc::new(test_record));

// ä¸¤ç§è®¿é—®è¯­æ³•éƒ½ä¼šéªŒè¯ï¼š
// (&record:get user :email) ä¼šäº§ç”Ÿè­¦å‘Š
// (user.-email) ä¹Ÿä¼šäº§ç”Ÿè­¦å‘Šï¼š
// [Warn] Field `email` does not exist in record `Person`. 
//        Available fields: [age, name]
```

**å®ç°ç»†èŠ‚ï¼ˆ2026-01-09ï¼‰ï¼š**

æ–‡ä»¶ä¿®æ”¹ï¼š
- `src/runner/preprocess.rs`:
  - æ‰©å±• `check_record_field_access()` å‡½æ•°æ”¯æŒ `Method(Access)` æ£€æŸ¥
  - åœ¨é¢„å¤„ç† `Proc`/`Import`/`Method` è°ƒç”¨æ—¶è§¦å‘å­—æ®µéªŒè¯
  - æ–°å¢ 4 ä¸ªå•å…ƒæµ‹è¯•ï¼ˆæ€»è®¡ 11 ä¸ªæµ‹è¯•ï¼‰

å·¥ä½œåŸç†ï¼š
1. ç”¨æˆ·ä½¿ç”¨ `assert-type user <record-instance>` æ ‡æ³¨å˜é‡ç±»å‹
2. ç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨ `scope_types: HashMap<Arc<str>, Arc<Calcit>>`
3. é¢„å¤„ç†åˆ°å­—æ®µè®¿é—®æ—¶ï¼ˆä¸¤ç§è¯­æ³•ï¼‰ï¼š
   - `&record:get user :field` - ç›´æ¥å‡½æ•°è°ƒç”¨
   - `user.-field` - è§£æä¸º `(.-field user)` æ–¹æ³•è°ƒç”¨
4. æ£€æŸ¥å™¨æå– Record ç±»å‹ï¼ŒéªŒè¯å­—æ®µå­˜åœ¨
5. ä¸å­˜åœ¨åˆ™ç”Ÿæˆç¼–è¯‘æ—¶è­¦å‘Š

**ä¸‹ä¸€æ­¥è®¡åˆ’ï¼ˆé˜¶æ®µ 4 å‰©ä½™å·¥ä½œï¼‰ï¼š**

1. ~~**æ”¯æŒ `.-field` æ–¹æ³•è®¿é—®è¯­æ³•çš„éªŒè¯**~~ âœ… å·²å®Œæˆ
   - âœ… å½“å‰æ”¯æŒ `&record:get` å’Œ `.-field` ä¸¤ç§è¯­æ³•
   - âœ… å®Œæ•´æµ‹è¯•è¦†ç›–

2. **åŸºäº Record å­—é¢é‡çš„ç±»å‹æ¨æ–­**
   - å½“çœ‹åˆ° `&%{} (&new-record :Person :name :age) ...` æ—¶è‡ªåŠ¨æ¨æ–­ç±»å‹
   - æ— éœ€æ˜¾å¼ `assert-type` æ ‡æ³¨
   - éœ€è¦åœ¨ `preprocess_list_call` ä¸­è¯†åˆ« `&new-record` è°ƒç”¨

3. **Enum å˜ä½“éªŒè¯**
   - æ£€æŸ¥ `tag-match` ä¸­çš„å˜ä½“æ˜¯å¦åœ¨ `defenum` å£°æ˜ä¸­
   - éªŒè¯å˜ä½“å‚æ•°æ•°é‡åŒ¹é…
   - éœ€è¦å®ç° Enum ç±»å‹çš„å­˜å‚¨å’ŒæŸ¥è¯¢

4. **`hint-fn` çš„æ”¶é›†å’ŒéªŒè¯**
   - å½“å‰åªæ˜¯è§£æï¼Œæœªå®é™…æ”¶é›†è¿”å›ç±»å‹ä¿¡æ¯
   - éœ€è¦åœ¨å‡½æ•°å®šä¹‰ä¸­æå– `hint-fn` ä¿¡æ¯å¹¶å­˜å‚¨åˆ° `CalcitFn.return_type`
   - éœ€è¦åœ¨å‡½æ•°è°ƒç”¨æ—¶éªŒè¯è¿”å›ç±»å‹åŒ¹é…

**é˜¶æ®µ 4 å·²å®Œæˆéƒ¨åˆ†ï¼š**
- âœ… Record å­—æ®µé™æ€éªŒè¯ï¼ˆ`&record:get` å’Œ `.-field`ï¼‰
- âœ… ç¼–è¯‘æ—¶è­¦å‘Šç”Ÿæˆ
- âœ… å®Œæ•´å•å…ƒæµ‹è¯•è¦†ç›–ï¼ˆ11ä¸ªæµ‹è¯•ï¼‰

**å®ç°ç»†èŠ‚ï¼š**

æ–‡ä»¶ä¿®æ”¹ï¼š
- `src/runner/preprocess.rs`:
  - æ·»åŠ äº† `check_record_field_access()` å‡½æ•°
  - æ·»åŠ äº† `check_field_in_record()` è¾…åŠ©å‡½æ•°
  - æ”¯æŒ `Proc(NativeRecordGet)`ã€`Import` å’Œ `Method(Access)` ä¸‰ç§å½¢å¼
  - åœ¨é¢„å¤„ç† `Proc`/`Import`/`Method` è°ƒç”¨æ—¶è§¦å‘å­—æ®µéªŒè¯
  - æ–°å¢ 4 ä¸ªå•å…ƒæµ‹è¯•éªŒè¯åŠŸèƒ½

å·¥ä½œåŸç†ï¼š
1. ç”¨æˆ·ä½¿ç”¨ `assert-type user <record-instance>` æ ‡æ³¨å˜é‡ç±»å‹
2. ç±»å‹ä¿¡æ¯å­˜å‚¨åœ¨ `scope_types: HashMap<Arc<str>, Arc<Calcit>>`
3. é¢„å¤„ç†åˆ° `&record:get user :field` æˆ– `user.-field` æ—¶ï¼š
   - æ£€æŸ¥ `user` åœ¨ `scope_types` ä¸­çš„ç±»å‹
   - å¦‚æœæ˜¯ `Calcit::Record`ï¼Œæå–å­—æ®µåˆ—è¡¨
   - ä½¿ç”¨ `record.index_of(field_name)` éªŒè¯å­—æ®µå­˜åœ¨
   - ä¸å­˜åœ¨åˆ™ç”Ÿæˆç¼–è¯‘æ—¶è­¦å‘Š

**å½“å‰é™åˆ¶ï¼š**
- éœ€è¦æ˜¾å¼ä½¿ç”¨ `assert-type` æ ‡æ³¨ï¼Œæ— æ³•è‡ªåŠ¨æ¨æ–­ Record å­—é¢é‡ç±»å‹
- è­¦å‘Šä¿¡æ¯åœ¨é¢„å¤„ç†é˜¶æ®µç”Ÿæˆï¼Œä¸å½±å“è¿è¡Œæ—¶
- ä¸æ”¯æŒåŠ¨æ€å­—æ®µåï¼ˆå¦‚å˜é‡æˆ–è¡¨è¾¾å¼è®¡ç®—çš„å­—æ®µåï¼‰

**å¾…å®Œå–„ï¼š**

é˜¶æ®µ 4 å·¥ä½œè¦ç‚¹ï¼š

1. **Record å­—æ®µæ ¡éªŒ**ï¼šåœ¨ `preprocess_list_call` ä¸­è¯»å– `assert-type` å†™å…¥çš„ `Record` å…ƒæ•°æ®ï¼Œç»™æ–¹æ³•è°ƒç”¨æä¾›å­—æ®µåˆ—è¡¨ï¼›
2. **å®æˆ˜æµ‹è¯•**ï¼šé’ˆå¯¹ demo Cirruï¼Œå¼•å…¥ `assert-type x :User` å¹¶åœ¨åç»­ `get x :name` ä¹‹ç±»çš„è°ƒç”¨é‡ŒéªŒè¯å­—æ®µå­˜åœ¨ï¼›
3. **Enum variant æ”¯æŒ**ï¼šä¸º `defenum` ç”Ÿæˆçš„æ„é€ å™¨è¡¥å…… `assert-type` ç¤ºä¾‹ï¼Œç¡®ä¿ matcher å¯ä»¥æ ¹æ® variant æ¨æ–­ç±»å‹ï¼›
4. **é”™è¯¯è¯Šæ–­**ï¼šå¢è¡¥ä¸€ç»„ `runner::preprocess` æµ‹è¯•ï¼Œæ¨¡æ‹Ÿéæ³•å­—æ®µå¹¶éªŒè¯ `LocatedWarning` è¾“å‡ºã€‚

## 7. å·²å®Œæˆçš„æ ¸å¿ƒæ”¹åŠ¨æ€»ç»“ï¼ˆæˆªè‡³ 2026-01-08ï¼‰

**é‡è¦è¯´æ˜**ï¼šä»¥ä¸‹æ€»ç»“çš„æ˜¯å½“å‰ **åŸå‹å®ç°**ï¼Œéœ€è¦å®Œå–„ä¸º `assert-type` å’Œ `hint-fn` è¯­æ³•ã€‚

### 7.1 æ•°æ®ç»“æ„å˜æ›´

| æ–‡ä»¶                   | ä¿®æ”¹å†…å®¹                                                   | çŠ¶æ€                                   |
| ---------------------- | ---------------------------------------------------------- | -------------------------------------- |
| `src/calcit/local.rs`  | `CalcitLocal` å·²æ‰©å±• `type_info: Option<Arc<Calcit>>` å­—æ®µ | âœ… å®Œæˆï¼Œæ— éœ€ä¿®æ”¹                      |
| `src/calcit/syntax.rs` | æ–°å¢ `CalcitSyntax::AssetType` æšä¸¾é¡¹                      | âš ï¸ éœ€è¦é‡æ„ä¸º `AssertType` å’Œ `HintFn` |

### 7.2 è¯­æ³•è§£æï¼ˆéœ€è¦é‡æ„ï¼‰

| æ–‡ä»¶                | å½“å‰å®ç°çŠ¶æ€                                                                                      | éœ€è¦ä¿®æ”¹ä¸º                                                                                             |
| ------------------- | ------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ |
| `src/data/cirru.rs` | è¯†åˆ«è¯­æ³•å­—ç¬¦ä¸²å¹¶è½¬æ¢ä¸º `CalcitSyntax` æšä¸¾<br>å•æµ‹ï¼š`parses_assert_type_list`ï¼ˆå¯èƒ½éœ€è¦æ›´æ–°å‘½åï¼‰ | ç¡®ä¿æ­£ç¡®è¯†åˆ« `"assert-type"` â†’ `CalcitSyntax::AssertType`<br>è¯†åˆ« `"hint-fn"` â†’ `CalcitSyntax::HintFn` |

### 7.3 é¢„å¤„ç†å™¨æ ¸å¿ƒé€»è¾‘ï¼ˆéœ€è¦é‡æ„ï¼‰

**`src/runner/preprocess.rs`** - å½“å‰çŠ¶æ€ï¼š

- âœ… å¼•å…¥ `ScopeTypes = HashMap<Arc<str>, Arc<Calcit>>` ç±»å‹åˆ«åï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- âœ… æ‰€æœ‰ `preprocess_*` å‡½æ•°ç­¾åæ–°å¢ `scope_types: &mut ScopeTypes` å‚æ•°ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- âœ… `preprocess_expr` åœ¨è½¬æ¢ `Symbol` â†’ `Local` æ—¶ä» `scope_types` æŸ¥è¯¢å¹¶å¡«å…… `type_info`ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- âš ï¸ **éœ€è¦é‡æ„**ï¼šå°† `preprocess_asset_type` å‡½æ•°æ‹†åˆ†ä¸ºï¼š
  - `preprocess_assert_type(expr, scope_types)` - å¤„ç† `assert-type var type` è¯­æ³•
  - `preprocess_hint_fn(expr, fn_info)` - å¤„ç† `hint-fn $ return-type type` è¯­æ³•
- âœ… `preprocess_defn`/`preprocess_core_let` åˆ›å»ºæ–°ä½œç”¨åŸŸæ—¶å…‹éš†çˆ¶çº§ `scope_types`ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰
- âš ï¸ å•æµ‹éœ€è¦æ›´æ–°ï¼š`passes_asset_type_through_preprocess` â†’ `passes_assert_type_through_preprocess`
- âš ï¸ å•æµ‹éœ€è¦æ›´æ–°ï¼š`propagates_type_info_across_scope`ï¼ˆæ›´æ–°æµ‹è¯•ä»£ç ä¸­çš„è¯­æ³•ï¼‰

**`src/builtins/syntax.rs`** - å½“å‰çŠ¶æ€ï¼š

- âœ… `macroexpand_all` å’Œç›¸å…³å®å¤„ç†å‡½æ•°è°ƒç”¨ `preprocess_expr` æ—¶ä¼ å…¥ `scope_types`ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

**`src/codegen/gen_ir.rs`** - å½“å‰çŠ¶æ€ï¼š

- âœ… `dump_code` ç”Ÿæˆ IR æ—¶åŒ…å« `Local` çš„ `type-info` å­—æ®µï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

### 7.4 ç±»å‹ä¼ æ’­æœºåˆ¶ï¼ˆåŸå‹å®ç°ï¼Œéœ€è¦é€‚é…æ–°è¯­æ³•ï¼‰

å½“å‰çš„ä¼ æ’­è·¯å¾„ï¼ˆåŸºäº `assert-type`ï¼‰ï¼š

1. **æ ‡æ³¨ç‚¹**ï¼š`assert-type x :number` è§£æä¸º `CalcitSyntax::AssertType` èŠ‚ç‚¹
2. **å†™å…¥æ˜ å°„**ï¼š`preprocess_assert_type` å°† `x` â†’ `:number` å†™å…¥ `scope_types`
3. **å›å¡« Local**ï¼šåç»­ä»»ä½•å¯¹ `x` çš„å¼•ç”¨ï¼ˆ`Symbol` â†’ `Local` è½¬æ¢æ—¶ï¼‰éƒ½ä¼šä» `scope_types` ä¸­æŸ¥è¯¢å¹¶å¡«å…… `type_info`
4. **ä½œç”¨åŸŸä¼ é€’**ï¼š`defn`/`&let` ç­‰åˆ›å»ºæ–°ä½œç”¨åŸŸæ—¶å…‹éš†çˆ¶çº§ `scope_types`ï¼Œç¡®ä¿ç±»å‹ä¿¡æ¯åœ¨åµŒå¥—ä½œç”¨åŸŸå†…å¯è§
5. **å‡½æ•°å…ƒæ•°æ®**ï¼š`hint-fn $ return-type :number` æ›´æ–°å½“å‰å‡½æ•°å®šä¹‰çš„ `FnInfo` ç»“æ„

### 7.5 æµ‹è¯•è¦†ç›–ï¼ˆéœ€è¦æ›´æ–°è¯­æ³•ï¼‰

| æµ‹è¯•ç”¨ä¾‹                                                           | éªŒè¯å†…å®¹                                                           | çŠ¶æ€                          |
| ------------------------------------------------------------------ | ------------------------------------------------------------------ | ----------------------------- |
| `data::cirru::tests::parses_assert_type_list`                      | éªŒè¯ Cirru è§£æå™¨èƒ½æ­£ç¡®è¯†åˆ« `assert-type` è¯­æ³•                     | âš ï¸ éœ€è¦æ£€æŸ¥æµ‹è¯•åç§°æ˜¯å¦å·²æ›´æ–° |
| `runner::preprocess::tests::passes_assert_type_through_preprocess` | éªŒè¯ `assert-type` è¡¨è¾¾å¼èƒ½é€šè¿‡é¢„å¤„ç†å™¨                            | âš ï¸ éœ€è¦æ£€æŸ¥æµ‹è¯•åç§°æ˜¯å¦å·²æ›´æ–° |
| `runner::preprocess::tests::propagates_type_info_across_scope`     | éªŒè¯ç±»å‹ä¿¡æ¯åœ¨ `&let` ä½œç”¨åŸŸå†…ä¼ æ’­ï¼Œåç»­å¼•ç”¨åŒä¸€å˜é‡æ—¶ä¿ç•™ç±»å‹æ ‡æ³¨ | âš ï¸ éœ€è¦æ›´æ–°æµ‹è¯•ä»£ç è¯­æ³•       |

---

**é‡æ„ä¼˜å…ˆçº§**ï¼š

1. **é«˜ä¼˜å…ˆçº§**ï¼šæ›´æ–°è¯­æ³•è§£æï¼ˆ`src/data/cirru.rs` å’Œ `src/calcit/syntax.rs`ï¼‰
2. **é«˜ä¼˜å…ˆçº§**ï¼šé‡æ„é¢„å¤„ç†å™¨å‡½æ•°ï¼ˆ`src/runner/preprocess.rs`ï¼‰
3. **ä¸­ä¼˜å…ˆçº§**ï¼šæ·»åŠ å‡½æ•°å…ƒæ•°æ®ç»“æ„å’Œ `hint-fn` å¤„ç†
4. **ä½ä¼˜å…ˆçº§**ï¼šæ›´æ–°æµ‹è¯•ç”¨ä¾‹è¯­æ³•

---

é˜¶æ®µ 4 å·¥ä½œè¦ç‚¹ï¼š

---

_è¯„ä¼°æ—¥æœŸ: 2026-01-08 Â· å¼€å‘çŠ¶æ€ï¼šé˜¶æ®µ 3 å·²å®Œæˆï¼Œè¿›å…¥é˜¶æ®µ 4_

## 8. åç»­å¼€å‘ä»»åŠ¡æ¸…å•ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

### 8.1 é˜¶æ®µ 4 å‰ç½®å‡†å¤‡ï¼ˆä¼°æ—¶ï¼š0.5 å¤©ï¼‰

- [ ] **ä»»åŠ¡ 4.1**ï¼šæ¢³ç†ç°æœ‰ Record å®šä¹‰æ–¹å¼ï¼Œç¡®è®¤ `defrecord` è¯­æ³•å’Œå…ƒæ•°æ®å­˜å‚¨ä½ç½®

  - æŸ¥æ‰¾ `src/builtins/` ä¸­ä¸ `defrecord` ç›¸å…³çš„å®ç°
  - ç¡®è®¤ Record å­—æ®µåˆ—è¡¨å¦‚ä½•åœ¨ç¨‹åºè¿è¡Œæ—¶è¢«è®¿é—®
  - ç¼–å†™æµ‹è¯• demoï¼šå®šä¹‰ä¸€ä¸ªç®€å• Record å¹¶éªŒè¯å­—æ®µæå–

- [ ] **ä»»åŠ¡ 4.2**ï¼šè®¾è®¡ç±»å‹æŸ¥è¯¢æ¥å£
  - åœ¨ `program.rs` æˆ–æ–°å»ºæ¨¡å—ä¸­æ·»åŠ  `lookup_record_fields(ns: &str, record_name: &str) -> Option<Vec<String>>` æ¥å£
  - æ”¯æŒä» `assert-type` çš„ç±»å‹æ ‡æ³¨ï¼ˆå¦‚ `:User`ï¼‰åæŸ¥å­—æ®µåˆ—è¡¨

### 8.2 Record å­—æ®µé™æ€æ ¡éªŒï¼ˆä¼°æ—¶ï¼š2 å¤©ï¼‰

- [ ] **ä»»åŠ¡ 4.3**ï¼šå®ç°æ–¹æ³•è°ƒç”¨çš„ Record å­—æ®µéªŒè¯

  - åœ¨ `preprocess_list_call` ä¸­è¯†åˆ« `get`/`.-field` ç­‰æ–¹æ³•è°ƒç”¨
  - å½“ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¸¦æœ‰ Record `type_info` çš„ `Local` æ—¶ï¼Œæ£€æŸ¥å­—æ®µåæ˜¯å¦åœ¨ Record å®šä¹‰ä¸­
  - ä¸åŒ¹é…æ—¶ç”Ÿæˆ `LocatedWarning` å¹¶è®°å½•åˆ° `check_warnings`

- [ ] **ä»»åŠ¡ 4.4**ï¼šç¼–å†™ Record å­—æ®µæ ¡éªŒå•æµ‹

  - æµ‹è¯•ç”¨ä¾‹ 1ï¼šåˆæ³•å­—æ®µè®¿é—®ï¼ˆå¦‚ `get user :name` å½“ `user` æ ‡æ³¨ä¸º `:User` ä¸” `:name` å­˜åœ¨ï¼‰
  - æµ‹è¯•ç”¨ä¾‹ 2ï¼šéæ³•å­—æ®µè®¿é—®ï¼ˆå¦‚ `get user :age` å½“ `:age` ä¸å­˜åœ¨äº Record å®šä¹‰ï¼‰
  - æµ‹è¯•ç”¨ä¾‹ 3ï¼šæœªæ ‡æ³¨ç±»å‹çš„å˜é‡ä¸è§¦å‘æ ¡éªŒ

- [ ] **ä»»åŠ¡ 4.5**ï¼šåœ¨å®é™… Cirru demo ä¸­éªŒè¯
  - åœ¨ `calcit/` æˆ– `demos/` ä¸‹åˆ›å»ºä¸€ä¸ªåŒ…å« Record å®šä¹‰å’Œä½¿ç”¨çš„ `.cirru` æ–‡ä»¶
  - æ•…æ„å†™é”™å­—æ®µåï¼Œè¿è¡Œ `cr --check-only` éªŒè¯æ˜¯å¦æ­£ç¡®æŠ¥å‘Šè­¦å‘Š

### 8.3 Enum variant æ”¯æŒï¼ˆå¯é€‰ï¼Œä¼°æ—¶ï¼š1.5 å¤©ï¼‰

- [ ] **ä»»åŠ¡ 4.6**ï¼šè°ƒç ” `defenum` å®ç°ç°çŠ¶

  - æŸ¥çœ‹æ˜¯å¦å·²æœ‰ `defenum` æˆ–ç±»ä¼¼çš„æšä¸¾å®šä¹‰è¯­æ³•
  - å¦‚æœæ²¡æœ‰ï¼Œè¯„ä¼°æ˜¯å¦éœ€è¦åœ¨æ­¤é˜¶æ®µå®ç°ï¼Œæˆ–å…ˆç”¨ Record ä»£æ›¿

- [ ] **ä»»åŠ¡ 4.7**ï¼šä¸º Enum å®ç° variant æ ¡éªŒ
  - åœ¨ pattern matching æˆ– `case` è¡¨è¾¾å¼ä¸­æ£€æŸ¥ variant åç§°åˆæ³•æ€§
  - ç”Ÿæˆå¯¹åº”çš„ `LocatedWarning`

### 8.4 å†…ç½®å‡½æ•°ç±»å‹æç¤ºï¼ˆä¼°æ—¶ï¼š1.5 å¤©ï¼‰

- [ ] **ä»»åŠ¡ 4.8**ï¼šè®¾è®¡å†…ç½®å‡½æ•°ç­¾åæè¿°æ ¼å¼

  - åœ¨ `src/builtins.rs` æˆ– `CalcitProc` ä¸­æ‰©å±•å…ƒæ•°æ®ç»“æ„
  - å®šä¹‰ç®€å•çš„ç±»å‹ç­¾åæ ¼å¼ï¼ˆå¦‚ `"(fn (a b) c)"` æˆ–ä½¿ç”¨ Calcit å€¼è¡¨ç¤ºï¼‰

- [ ] **ä»»åŠ¡ 4.9**ï¼šä¸ºå¸¸ç”¨å†…ç½®å‡½æ•°æ·»åŠ ç­¾å

  - ä¼˜å…ˆè¦†ç›–ï¼š`+`ã€`-`ã€`*`ã€`/`ã€`str`ã€`get`ã€`assoc`ã€`dissoc`ã€`map`ã€`filter` ç­‰é«˜é¢‘å‡½æ•°
  - ç¼–å†™å•æµ‹éªŒè¯ç­¾åå¯è¢«æŸ¥è¯¢

- [ ] **ä»»åŠ¡ 4.10**ï¼šåœ¨é¢„å¤„ç†å™¨ä¸­ä½¿ç”¨å†…ç½®å‡½æ•°ç­¾å
  - å½“è°ƒç”¨ `Proc` æ—¶ï¼Œæ ¹æ®ç­¾åè¿›è¡Œå‚æ•°ç±»å‹æ£€æŸ¥
  - ç”Ÿæˆç±»å‹ä¸åŒ¹é…çš„ `LocatedWarning`ï¼ˆåˆæœŸå¯ä»¥åªåšå‚æ•°æ•°é‡æ ¡éªŒï¼‰

### 8.5 è¿è¡Œæ—¶ç±»å‹æŸ¥çœ‹ï¼ˆä¼°æ—¶ï¼š1 å¤©ï¼‰

- [ ] **ä»»åŠ¡ 4.11**ï¼šå®ç° `&inspect-type` åŸè¯­

  - åœ¨ `src/builtins/` ä¸­æ·»åŠ æ–°çš„ procï¼Œæ¥å—ä¸€ä¸ª `Local` å¹¶è¿”å›å…¶ `type_info`
  - æ”¯æŒåœ¨ REPL æˆ–æµ‹è¯•ä»£ç ä¸­åŠ¨æ€æŸ¥çœ‹ç±»å‹æ ‡æ³¨

- [ ] **ä»»åŠ¡ 4.12**ï¼šå¢å¼ºé”™è¯¯ä¿¡æ¯æ˜¾ç¤º
  - å½“ç±»å‹ç›¸å…³çš„ `LocatedWarning` è¢«æ‰“å°æ—¶ï¼ŒåŒ…å«å˜é‡çš„ `type_info` å†…å®¹
  - åœ¨ `LocatedWarning::print_list` ä¸­ä¼˜åŒ–æ ¼å¼

### 8.6 æ–‡æ¡£ä¸ç¤ºä¾‹ï¼ˆä¼°æ—¶ï¼š1 å¤©ï¼‰

- [ ] **ä»»åŠ¡ 4.13**ï¼šç¼–å†™ç”¨æˆ·æ–‡æ¡£

  - åœ¨ `docs/` ä¸‹åˆ›å»º `type-annotations.md`ï¼Œè¯´æ˜ `assert-type` å’Œ `hint-fn` è¯­æ³•
  - æä¾› Record å­—æ®µæ ¡éªŒçš„ç¤ºä¾‹ä»£ç 
  - è¯´æ˜ `unknown` ç±»å‹çš„è¯­ä¹‰å’Œå‘åå…¼å®¹ç­–ç•¥

- [ ] **ä»»åŠ¡ 4.14**ï¼šæ›´æ–° README å’Œ changelog
  - åœ¨ `README.md` ä¸­æ·»åŠ ç±»å‹æ ‡è®°åŠŸèƒ½çš„ç®€ä»‹
  - è®°å½•åˆ°ç‰ˆæœ¬ changelogï¼ˆå¦‚æœè®¡åˆ’å‘å¸ƒï¼‰

### 8.7 é›†æˆæµ‹è¯•ä¸æ€§èƒ½ä¼˜åŒ–ï¼ˆä¼°æ—¶ï¼š1 å¤©ï¼‰

- [ ] **ä»»åŠ¡ 4.15**ï¼šè¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶

  - ç¡®ä¿æ‰€æœ‰ç°æœ‰æµ‹è¯•ä»ç„¶é€šè¿‡
  - æ£€æŸ¥é¢„å¤„ç†å™¨æ€§èƒ½ï¼Œå°¤å…¶æ˜¯å¤§å‹é¡¹ç›®ä¸­çš„ç±»å‹æ˜ å°„æŸ¥æ‰¾å¼€é”€

- [ ] **ä»»åŠ¡ 4.16**ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰
  - è€ƒè™‘ä½¿ç”¨ `Arc` æˆ–å¼•ç”¨è®¡æ•°å‡å°‘ `ScopeTypes` å…‹éš†å¼€é”€
  - å¯¹çƒ­è·¯å¾„ï¼ˆå¦‚ `preprocess_expr` ä¸­çš„ Local è½¬æ¢ï¼‰è¿›è¡Œ profiling

---

### ğŸ“‹ ä»»åŠ¡æ‰§è¡Œé¡ºåºå»ºè®®

**ç¬¬ä¸€å‘¨**ï¼ˆä¼˜å…ˆå®Œæˆ Record æ ¡éªŒæ ¸å¿ƒåŠŸèƒ½ï¼‰ï¼š

1. ä»»åŠ¡ 4.1, 4.2ï¼ˆå‰ç½®å‡†å¤‡ï¼‰
2. ä»»åŠ¡ 4.3, 4.4ï¼ˆRecord å­—æ®µæ ¡éªŒæ ¸å¿ƒï¼‰
3. ä»»åŠ¡ 4.5ï¼ˆå®æˆ˜éªŒè¯ï¼‰

**ç¬¬äºŒå‘¨**ï¼ˆæ‰©å±•åŠŸèƒ½ä¸å®Œå–„ï¼‰ï¼š 4. ä»»åŠ¡ 4.11, 4.12ï¼ˆè¿è¡Œæ—¶æ”¯æŒï¼‰ 5. ä»»åŠ¡ 4.8, 4.9ï¼ˆå†…ç½®å‡½æ•°ç­¾åï¼Œéƒ¨åˆ†ï¼‰ 6. ä»»åŠ¡ 4.13, 4.14ï¼ˆæ–‡æ¡£ï¼‰

**ç¬¬ä¸‰å‘¨**ï¼ˆæ”¶å°¾ä¸ä¼˜åŒ–ï¼‰ï¼š 7. ä»»åŠ¡ 4.10ï¼ˆå†…ç½®å‡½æ•°ç±»å‹æ£€æŸ¥ï¼‰ 8. ä»»åŠ¡ 4.15, 4.16ï¼ˆé›†æˆæµ‹è¯•ä¸æ€§èƒ½ï¼‰ 9. å¯é€‰ï¼šä»»åŠ¡ 4.6, 4.7ï¼ˆEnum æ”¯æŒï¼‰

---

_è¯„ä¼°æ—¥æœŸ: 2026-01-08 Â· å¼€å‘çŠ¶æ€ï¼šé˜¶æ®µ 3 å·²å®Œæˆï¼Œè¿›å…¥é˜¶æ®µ 4_

## 6. `defenum` è®¾è®¡è‰æ¡ˆ

ä¸ºäº†åœ¨ tuple ä¸Šå®ç°æ›´å¼ºçš„ä»£æ•°æ•°æ®ç±»å‹èƒ½åŠ›ï¼Œå¯ä»¥å¼•å…¥è½»é‡çš„ `defenum` è¯­æ³•ï¼Œä¸ºç°æœ‰çš„ `tag-match` æä¾›ç»“æ„åŒ–çš„ç±»å‹å£°æ˜ã€‚

### 6.1 ç°æœ‰åŸºç¡€ï¼š`tag-match`

Calcit å·²ç»å…·å¤‡åŸºäº tagged tuple çš„æ¨¡å¼åŒ¹é…èƒ½åŠ›ï¼š

```cirru
; ç°æœ‰ç”¨æ³•
tag-match (:: :ok 1)
  (:ok v) (&+ v 10)
  (:err e) (eprintln e)

tag-match (:: :some |hello)
  (:some x) (str |got: x)
  (:none) |nothing
```

**ç°çŠ¶åˆ†æ**ï¼š

- âœ… å·²æœ‰ `::` è¯­æ³•åˆ›å»º tagged tuple
- âœ… å·²æœ‰ `tag-match` å®è¿›è¡Œ pattern matching
- âœ… æ”¯æŒå‚æ•°æ•°é‡æ£€æŸ¥ï¼ˆ`tag-match` ä¼šéªŒè¯ tuple é•¿åº¦ï¼‰
- âŒ ç¼ºå°‘ç±»å‹å£°æ˜ï¼šæ— æ³•äº‹å…ˆå®šä¹‰åˆæ³•çš„ variant é›†åˆ
- âŒ ç¼ºå°‘é™æ€æ ¡éªŒï¼šæ‹¼å†™é”™è¯¯çš„ tag åç§°ä¸ä¼šè¢«å‘ç°

### 6.2 `defenum` å¢å¼ºæ–¹æ¡ˆ

åœ¨ç°æœ‰åŸºç¡€ä¸Šæ·»åŠ ç±»å‹å£°æ˜ï¼š

```cirru
defenum Result
  :ok value             ; variant å¸¦ä¸€ä¸ªå‚æ•°
  :err message          ; variant å¸¦ä¸€ä¸ªå‚æ•°

defenum Option
  :some value           ; variant å¸¦ä¸€ä¸ªå‚æ•°
  :none                 ; variant æ— å‚æ•°

defenum Event
  :click x y            ; variant å¸¦ä¸¤ä¸ªå‚æ•°
  :keypress code meta   ; variant å¸¦ä¸¤ä¸ªå‚æ•°
  :message text user timestamp  ; variant å¸¦ä¸‰ä¸ªå‚æ•°
```

ä½¿ç”¨ç¤ºä¾‹ï¼ˆä¿æŒä¸ç°æœ‰ `tag-match` å…¼å®¹ï¼‰ï¼š

```cirru
defn handle-result (result)
  ; å‡è®¾ result å·²é€šè¿‡ assert-type æ ‡æ³¨ä¸º :Result
  tag-match result
    (:ok v) (println "Success:" v)
    (:err e) (println "Error:" e)
```

**å®ç°è¦ç‚¹**ï¼š

1. **å…ƒæ•°æ®æ³¨å†Œ**ï¼š`defenum` åœ¨å…¨å±€æ³¨å†Œè¡¨ä¸­è®°å½•ï¼š

   - Enum åç§°ï¼ˆå¦‚ `Result`ï¼Œå­˜å‚¨åœ¨å½“å‰ namespaceï¼‰
   - æ¯ä¸ª variant çš„åç§°å’Œå‚æ•°æ•°é‡
   - å‚æ•°åç§°ï¼ˆä»…ç”¨äºæ–‡æ¡£å’Œé”™è¯¯æç¤ºï¼‰

2. **é¢„å¤„ç†å™¨å¢å¼º**ï¼šåœ¨ `tag-match` å®å±•å¼€åçš„é¢„å¤„ç†é˜¶æ®µï¼š

   - å½“å˜é‡é€šè¿‡ `assert-type` æ ‡æ³¨ä¸ºæŸä¸ª enum ç±»å‹æ—¶
   - æ£€æŸ¥ `tag-match` åˆ†æ”¯ä¸­çš„ pattern æ˜¯å¦ä¸ºè¯¥ enum çš„åˆæ³• variant
   - æ£€æŸ¥å‚æ•°æ•°é‡æ˜¯å¦åŒ¹é… defenum å£°æ˜
   - å¯é€‰ï¼šæç¤ºæœªè¦†ç›–çš„ variantï¼ˆexhaustiveness checkï¼‰

3. **å‘åå…¼å®¹**ï¼š

   - æœªæ ‡æ³¨ç±»å‹çš„ tuple ä»å¯æ­£å¸¸ä½¿ç”¨ `tag-match`ï¼Œä¸è§¦å‘æ ¡éªŒ
   - `defenum` ä¸æ”¹å˜è¿è¡Œæ—¶è¡Œä¸ºï¼Œä»…æä¾›ç¼–è¯‘æœŸæ£€æŸ¥
   - ç»§ç»­ä½¿ç”¨ç°æœ‰çš„ `CalcitTuple` æ•°æ®ç»“æ„

4. **å†…çœæ”¯æŒ**ï¼š
   - `enum-variants :Result` è¿”å› `[] ([] :ok 1) ([] :err 1)`ï¼ˆvariant åŠå‚æ•°æ•°é‡ï¼‰
   - `enum-variants :Event` è¿”å› `[] ([] :click 2) ([] :keypress 2) ([] :message 3)`
   - `enum? x` æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæŸä¸ªå·²å®šä¹‰ enum çš„å®ä¾‹

### 6.3 ä¸ `assert-type` çš„é›†æˆ

```cirru
defn process-data (input)
  &let (result (fetch-data input))
    assert-type result :Result  ; æ ‡æ³¨ç±»å‹
    tag-match result
      (:ok data) (save-to-db data)
      (:err msg) (log-error msg)
      ; é¢„å¤„ç†å™¨ä¼šè­¦å‘Šï¼šå¦‚æœ Result æœ‰å…¶ä»– variant æœªè¢«å¤„ç†
```

**åç»­å·¥ä½œ**ï¼š

- **é˜¶æ®µ 4**ï¼šå®ç° `defenum` è¯­æ³•è§£æå’Œå…ƒæ•°æ®æ³¨å†Œ
- **é˜¶æ®µ 5**ï¼šåœ¨é¢„å¤„ç†å™¨ä¸­éªŒè¯ `tag-match` pattern çš„åˆæ³•æ€§
- **é˜¶æ®µ 6**ï¼šå®ç° exhaustiveness checkï¼ˆå¯é€‰ï¼‰
- è¡¥å……æ–‡æ¡£è¯´æ˜ enum å£°æ˜å’Œ `tag-match` çš„é…åˆä½¿ç”¨æ¨¡å¼
